# å„€è¡¨æ¿æ¬Šé™æ›´æ–°èªªæ˜

## ğŸ¯ æ›´æ–°ç›®æ¨™

ä¿®æ”¹å„€è¡¨æ¿è¨­å®šï¼Œè®“è³‡å®‰å°ˆå®¶å¯ä»¥çœ‹åˆ°è‡ªå·±çš„çµ±è¨ˆæ•¸æ“šï¼Œè€Œç³»çµ±ç®¡ç†å“¡å¯ä»¥çœ‹åˆ°æ‰€æœ‰äººçš„çµ±è¨ˆæ•¸æ“šï¼Œè§£æ±ºè³‡å®‰å°ˆå®¶è¨ªå•å„€è¡¨æ¿æ™‚é‡åˆ°çš„ 403 Forbidden éŒ¯èª¤ã€‚

## ğŸ”§ ä¸»è¦ä¿®æ”¹

### 1. å¾Œç«¯ API ä¿®æ”¹

#### ä¿®æ”¹æ–‡ä»¶ï¼š`backend/app/api/v1/stats.py`

**åŸä¾†çš„å•é¡Œï¼š**
- åªå…è¨±ç®¡ç†å“¡è¨ªå•çµ±è¨ˆ API
- ä½¿ç”¨ `get_current_admin_user` ä¾è³´ï¼Œå°è‡´è³‡å®‰å°ˆå®¶è¢«æ‹’çµ•è¨ªå•

**ä¿®æ”¹å…§å®¹ï¼š**
```python
# ä¿®æ”¹å‰
@router.get("/", response_model=schemas.DashboardStats)
def get_dashboard_stats(
    db: Session = Depends(get_db),
    admin_user: models.User = Depends(get_current_admin_user)  # åªå…è¨±ç®¡ç†å“¡
):

# ä¿®æ”¹å¾Œ
@router.get("/", response_model=schemas.DashboardStats)
def get_dashboard_stats(
    db: Session = Depends(get_db),
    current_user: models.User = Depends(get_current_user)  # å…è¨±æ‰€æœ‰å·²ç™»å…¥ç”¨æˆ¶
):
    """
    Retrieve statistics for the dashboard.
    - Admin users see global statistics
    - Expert users see their personal statistics
    """
    if current_user.role == models.UserRole.ADMIN:
        # ç®¡ç†å“¡çœ‹åˆ°å…¨å±€çµ±è¨ˆ
        global_stats = crud.get_global_stats(db)
        review_activity = crud.get_review_activity(db, days=30)
        top_reviewers = crud.get_top_reviewers(db, limit=5)
        common_rejection_reasons = crud.get_common_rejection_reasons(db, limit=5)
    else:
        # è³‡å®‰å°ˆå®¶çœ‹åˆ°å€‹äººçµ±è¨ˆ
        global_stats = crud.get_user_stats(db, current_user.id)
        review_activity = crud.get_user_review_activity(db, current_user.id, days=30)
        top_reviewers = []  # å€‹äººçµ±è¨ˆä¸éœ€è¦é¡¯ç¤ºé ‚å°–å¯©æ ¸å“¡
        common_rejection_reasons = crud.get_user_rejection_reasons(db, current_user.id, limit=5)
```

### 2. æ–°å¢ CRUD å‡½æ•¸

#### ä¿®æ”¹æ–‡ä»¶ï¼š`backend/app/crud.py`

**æ–°å¢çš„å‡½æ•¸ï¼š**

1. **`get_user_stats(db: Session, user_id: int)`**
   - ç²å–ç‰¹å®šç”¨æˆ¶çš„çµ±è¨ˆæ•¸æ“š
   - åŒ…æ‹¬è©²ç”¨æˆ¶çš„å¯©æ ¸æ¬¡æ•¸ã€é€šéæ¬¡æ•¸ã€æ‹’çµ•æ¬¡æ•¸ç­‰

2. **`get_user_review_activity(db: Session, user_id: int, days: int = 30)`**
   - ç²å–ç‰¹å®šç”¨æˆ¶çš„å¯©æ ¸æ´»å‹•æ™‚é–“åºåˆ—
   - ç”¨æ–¼ç”Ÿæˆå€‹äººå¯©æ ¸æ´»å‹•åœ–è¡¨

3. **`get_user_rejection_reasons(db: Session, user_id: int, limit: int = 5)`**
   - ç²å–ç‰¹å®šç”¨æˆ¶çš„æ‹’çµ•ç†ç”±çµ±è¨ˆ
   - ç”¨æ–¼é¡¯ç¤ºå€‹äººæ‹’çµ•ç†ç”±åˆ†æ

### 3. å‰ç«¯ç•Œé¢ä¿®æ”¹

#### ä¿®æ”¹æ–‡ä»¶ï¼š`frontend/src/views/Dashboard.vue`

**ä¸»è¦ä¿®æ”¹ï¼š**

1. **å‹•æ…‹æ¨™é¡Œ**
   ```vue
   <h1 class="text-3xl font-bold text-gray-800 mb-6">
     {{ isAdmin ? 'ç³»çµ±çµ±è¨ˆå„€è¡¨æ¿' : 'å€‹äººçµ±è¨ˆå„€è¡¨æ¿' }}
   </h1>
   ```

2. **å‹•æ…‹ KPI æ¨™ç±¤**
   ```vue
   <h3 class="text-sm font-medium text-gray-500">
     {{ isAdmin ? 'è³‡æ–™ç¸½ç­†æ•¸' : 'å·²å¯©æ ¸è³‡æ–™ç­†æ•¸' }}
   </h3>
   ```

3. **æ¢ä»¶é¡¯ç¤ºé ‚å°–å¯©æ ¸å“¡**
   ```vue
   <!-- Top Reviewers (only for admin) -->
   <div v-if="isAdmin" class="bg-white p-6 rounded-lg shadow-md">
   ```

4. **å‹•æ…‹åœ–è¡¨æ¨™ç±¤**
   ```vue
   <h3 class="text-lg font-medium text-gray-800 mb-4">
     {{ isAdmin ? 'éå» 30 å¤©å¯©æ ¸æ´»å‹•' : 'éå» 30 å¤©æˆ‘çš„å¯©æ ¸æ´»å‹•' }}
   </h3>
   ```

## ğŸ“Š æ•¸æ“šå·®ç•°

### ç®¡ç†å“¡çœ‹åˆ°çš„æ•¸æ“šï¼š
- **è³‡æ–™ç¸½ç­†æ•¸**ï¼šç³»çµ±ä¸­æ‰€æœ‰å¾…å¯©æ ¸è³‡æ–™çš„ç¸½æ•¸
- **ç¸½å¯©æ ¸æ¬¡æ•¸**ï¼šæ‰€æœ‰ç”¨æˆ¶çš„å¯©æ ¸æ¬¡æ•¸ç¸½å’Œ
- **é€šéç‡/æ‹’çµ•ç‡**ï¼šå…¨å±€çš„é€šéç‡å’Œæ‹’çµ•ç‡
- **å¯©æ ¸æ´»å‹•**ï¼šæ‰€æœ‰ç”¨æˆ¶çš„å¯©æ ¸æ´»å‹•
- **é ‚å°–å¯©æ ¸å“¡**ï¼šå¯©æ ¸æ¬¡æ•¸æœ€å¤šçš„ç”¨æˆ¶æ’å
- **å¸¸è¦‹æ‹’çµ•ç†ç”±**ï¼šæ‰€æœ‰ç”¨æˆ¶çš„æ‹’çµ•ç†ç”±çµ±è¨ˆ

### è³‡å®‰å°ˆå®¶çœ‹åˆ°çš„æ•¸æ“šï¼š
- **å·²å¯©æ ¸è³‡æ–™ç­†æ•¸**ï¼šè©²å°ˆå®¶å¯©æ ¸éçš„è³‡æ–™é›†æ•¸é‡
- **æˆ‘çš„å¯©æ ¸æ¬¡æ•¸**ï¼šè©²å°ˆå®¶çš„å€‹äººå¯©æ ¸æ¬¡æ•¸
- **æˆ‘çš„é€šéç‡/æ‹’çµ•ç‡**ï¼šè©²å°ˆå®¶çš„å€‹äººé€šéç‡å’Œæ‹’çµ•ç‡
- **æˆ‘çš„å¯©æ ¸æ´»å‹•**ï¼šè©²å°ˆå®¶çš„å€‹äººå¯©æ ¸æ´»å‹•æ™‚é–“åºåˆ—
- **æˆ‘çš„æ‹’çµ•ç†ç”±**ï¼šè©²å°ˆå®¶çš„å€‹äººæ‹’çµ•ç†ç”±çµ±è¨ˆ
- **ä¸é¡¯ç¤ºé ‚å°–å¯©æ ¸å“¡**ï¼šå€‹äººçµ±è¨ˆä¸éœ€è¦é¡¯ç¤ºæ’å

## ğŸ” æ¬Šé™æ§åˆ¶

### è¨ªå•æ§åˆ¶ï¼š
- **æ‰€æœ‰å·²ç™»å…¥ç”¨æˆ¶**ï¼šéƒ½å¯ä»¥è¨ªå• `/api/v1/stats/` ç«¯é»
- **æ•¸æ“šéš”é›¢**ï¼šæ ¹æ“šç”¨æˆ¶è§’è‰²è¿”å›ä¸åŒçš„æ•¸æ“šç¯„åœ
- **å®‰å…¨æ€§**ï¼šç”¨æˆ¶åªèƒ½çœ‹åˆ°è‡ªå·±æœ‰æ¬Šé™çš„æ•¸æ“š

### è§’è‰²å€åˆ†ï¼š
- **ç®¡ç†å“¡ (ADMIN)**ï¼šçœ‹åˆ°å…¨å±€çµ±è¨ˆæ•¸æ“š
- **è³‡å®‰å°ˆå®¶ (EXPERT)**ï¼šçœ‹åˆ°å€‹äººçµ±è¨ˆæ•¸æ“š

## ğŸ¯ ç”¨æˆ¶é«”é©—æ”¹é€²

### 1. è§£æ±º 403 éŒ¯èª¤
- è³‡å®‰å°ˆå®¶ç¾åœ¨å¯ä»¥æ­£å¸¸è¨ªå•å„€è¡¨æ¿
- ä¸å†å‡ºç¾æ¬Šé™ä¸è¶³çš„éŒ¯èª¤

### 2. å€‹æ€§åŒ–é«”é©—
- ç®¡ç†å“¡ï¼šçœ‹åˆ°ç³»çµ±æ•´é«”ç‹€æ³ï¼Œä¾¿æ–¼ç®¡ç†æ±ºç­–
- è³‡å®‰å°ˆå®¶ï¼šçœ‹åˆ°å€‹äººå·¥ä½œæˆæœï¼Œä¾¿æ–¼è‡ªæˆ‘è©•ä¼°

### 3. æ•¸æ“šç›¸é—œæ€§
- æ¯å€‹ç”¨æˆ¶çœ‹åˆ°çš„æ•¸æ“šéƒ½èˆ‡è‡ªå·±çš„å·¥ä½œç›¸é—œ
- æé«˜æ•¸æ“šçš„å¯¦ç”¨æ€§å’Œåƒè€ƒåƒ¹å€¼

## ğŸ§ª æ¸¬è©¦é©—è­‰

### 1. ç®¡ç†å“¡æ¸¬è©¦
```bash
# ä½¿ç”¨ç®¡ç†å“¡å¸³è™Ÿç™»å…¥
curl -X GET "http://localhost:8000/api/v1/stats/" \
  -H "Authorization: Bearer {admin_token}"
# æ‡‰è©²è¿”å›å…¨å±€çµ±è¨ˆæ•¸æ“š
```

### 2. è³‡å®‰å°ˆå®¶æ¸¬è©¦
```bash
# ä½¿ç”¨è³‡å®‰å°ˆå®¶å¸³è™Ÿç™»å…¥
curl -X GET "http://localhost:8000/api/v1/stats/" \
  -H "Authorization: Bearer {expert_token}"
# æ‡‰è©²è¿”å›å€‹äººçµ±è¨ˆæ•¸æ“š
```

### 3. å‰ç«¯æ¸¬è©¦
- ç®¡ç†å“¡ç™»å…¥ï¼šé¡¯ç¤ºã€Œç³»çµ±çµ±è¨ˆå„€è¡¨æ¿ã€
- è³‡å®‰å°ˆå®¶ç™»å…¥ï¼šé¡¯ç¤ºã€Œå€‹äººçµ±è¨ˆå„€è¡¨æ¿ã€
- æ•¸æ“šå…§å®¹ï¼šæ ¹æ“šè§’è‰²é¡¯ç¤ºç›¸æ‡‰çš„çµ±è¨ˆä¿¡æ¯

## ğŸ“‹ ç›¸é—œæ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶ï¼š
1. `backend/app/api/v1/stats.py` - API ç«¯é»ä¿®æ”¹
2. `backend/app/crud.py` - æ–°å¢å€‹äººçµ±è¨ˆ CRUD å‡½æ•¸
3. `frontend/src/views/Dashboard.vue` - å‰ç«¯ç•Œé¢ä¿®æ”¹

### ç›¸é—œåŠŸèƒ½ï¼š
- ç”¨æˆ¶èªè­‰ç³»çµ±
- å¯©æ ¸è¨˜éŒ„ç³»çµ±
- çµ±è¨ˆæ•¸æ“šè¨ˆç®—

## âœ… å®Œæˆç‹€æ…‹

- [x] ä¿®æ”¹å¾Œç«¯ API æ¬Šé™æ§åˆ¶
- [x] æ–°å¢å€‹äººçµ±è¨ˆ CRUD å‡½æ•¸
- [x] ä¿®æ”¹å‰ç«¯ç•Œé¢é¡¯ç¤ºé‚è¼¯
- [x] é‡æ–°å•Ÿå‹•æœå‹™
- [x] å‰µå»ºèªªæ˜æ–‡æª”

ç¾åœ¨è³‡å®‰å°ˆå®¶å¯ä»¥æ­£å¸¸è¨ªå•å„€è¡¨æ¿ï¼Œçœ‹åˆ°è‡ªå·±çš„å€‹äººçµ±è¨ˆæ•¸æ“šï¼Œè€Œç®¡ç†å“¡ä»ç„¶å¯ä»¥çœ‹åˆ°å…¨å±€çµ±è¨ˆæ•¸æ“šã€‚ 