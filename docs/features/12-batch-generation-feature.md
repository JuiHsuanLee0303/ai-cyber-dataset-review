# 批量隨機生成與逐筆審批功能

## 🎯 功能概述

本次更新為法規生成功能新增了批量隨機生成和逐筆審批功能，大幅提升資料生成效率，並提供更精確的品質控制。

## 🚀 主要功能

### 1. 批量生成模式
- **生成模式選擇**：支援單筆生成和批量生成兩種模式
- **批量數量設定**：可設定 1-20 筆資料的生成數量
- **隨機法規選擇**：每次生成可隨機選擇 1-3 個法規條文
- **批量處理**：一次性生成多筆資料，提升效率

### 2. 逐筆審批功能
- **逐筆瀏覽**：可逐筆查看生成的資料內容
- **選擇/跳過**：對每筆資料可選擇加入或跳過
- **導航控制**：支援上一筆/下一筆導航
- **批量確認**：一次性確認所有選擇的資料

### 3. 智能法規選擇
- **隨機選擇**：啟用後系統自動從所有法規中隨機選擇，無需手動選擇
- **固定選擇**：關閉後需要手動選擇法規條文
- **組合多樣性**：確保生成資料的多樣性和覆蓋面
- **智能驗證**：根據選擇模式自動調整驗證邏輯

## 🔧 技術實現

### 後端 API 擴展

#### 1. 批量生成端點
```python
@router.post("/batch-generate-from-regulations", response_model=schemas.BatchGeneratedDataset)
async def batch_generate_datasets_from_regulations(
    request: schemas.BatchGenerateFromRegulationsRequest,
    db: Session = Depends(get_db),
    admin_user: models.User = Depends(get_current_admin_user)
):
    """
    Generate multiple datasets from selected legal regulations using Ollama.
    Supports random selection of regulations for each generation.
    """
```

#### 2. 批量確認端點
```python
@router.post("/batch-confirm-generated", response_model=List[schemas.RawDataset])
def batch_confirm_generated_datasets(
    datasets: List[schemas.RawDatasetCreate],
    db: Session = Depends(get_db),
    admin_user: models.User = Depends(get_current_admin_user)
):
    """
    Confirm and save multiple generated datasets to the database.
    """
```

#### 3. 新增 Schema 結構
```python
class BatchGenerateFromRegulationsRequest(BaseModel):
    selected_article_ids: List[int]
    model_name: Optional[str] = None
    batch_size: int = 1  # 批量生成數量
    random_selection: bool = True  # 是否隨機選擇法規

class BatchGeneratedDataset(BaseModel):
    datasets: List[GeneratedDataset]
    total_generated: int
    success_count: int
    failed_count: int
```

### 前端界面優化

#### 1. 生成模式選擇
- 單筆生成：傳統的一筆一筆生成模式
- 批量生成：新增的批量生成模式

#### 2. 批量設定面板
- 生成數量：1-20 筆可調整
- 隨機選擇：開關控制法規選擇方式

#### 3. 逐筆審批界面
- 導航控制：上一筆/下一筆按鈕
- 選擇狀態：選擇/跳過按鈕
- 進度顯示：當前筆數/總筆數
- 批量摘要：成功/失敗統計

## 📊 使用流程

### 1. 選擇生成模式
1. 點擊「從法規生成」按鈕
2. 選擇「單筆生成」或「批量生成」
3. 如選擇批量生成，設定生成數量和隨機選擇

### 2. 選擇法規和模型
1. 選擇要使用的 AI 模型
2. 選擇法規條文（如啟用隨機選擇則無需手動選擇）
3. 點擊「批量生成 X 筆資料」

### 3. 逐筆審批
1. 查看批量生成摘要
2. 使用導航按鈕逐筆瀏覽
3. 對每筆資料選擇「選擇」或「跳過」
4. 完成所有審批後點擊「確認加入」

### 4. 批量確認
1. 系統顯示選擇的資料數量
2. 點擊「確認加入 (X 筆)」
3. 成功後資料自動加入待審核資料集

## 🎨 界面特色

### 1. 直觀的模式選擇
- 卡片式設計，清楚區分兩種模式
- 即時顯示選擇狀態
- 響應式佈局，支援各種螢幕尺寸

### 2. 智能的批量設定
- 數量限制：防止過度生成
- 即時驗證：確保設定有效
- 提示說明：清楚的操作指引

### 3. 流暢的審批體驗
- 導航控制：輕鬆切換不同資料
- 狀態顯示：清楚顯示選擇狀態
- 進度追蹤：即時顯示審批進度

### 4. 詳細的結果展示
- 生成摘要：成功/失敗統計
- 內容預覽：完整的資料內容
- 來源顯示：清楚的法規來源

## 🔍 品質控制

### 1. 生成品質
- **隨機選擇**：確保資料多樣性
- **法規組合**：避免單一法規的局限性
- **模型選擇**：支援多模型生成

### 2. 審批品質
- **逐筆審核**：確保每筆資料品質
- **選擇控制**：可跳過不合格資料
- **批量確認**：一次性處理多筆資料

### 3. 錯誤處理
- **生成失敗**：統計失敗數量
- **網路錯誤**：自動重試機制
- **超時處理**：適當的超時設定

## 📈 效能優化

### 1. 批量處理
- **並行生成**：提升生成效率
- **批量確認**：減少 API 調用次數
- **狀態管理**：優化記憶體使用

### 2. 用戶體驗
- **進度顯示**：清楚的操作反饋
- **導航優化**：流暢的切換體驗
- **錯誤處理**：友好的錯誤提示

### 3. 系統穩定性
- **超時設定**：防止長時間等待
- **錯誤恢復**：自動錯誤處理
- **狀態同步**：確保資料一致性

## 🚨 注意事項

### 1. 生成數量限制
- 建議一次生成 1-20 筆資料
- 過多資料可能影響生成品質
- 大量生成需要較長時間

### 2. 法規選擇建議
- 選擇相關性高的法規組合
- 啟用隨機選擇可自動增加多樣性，無需手動選擇
- 避免選擇過多不相關法規
- 隨機選擇模式會自動從所有法規中選擇

### 3. 審批建議
- 逐筆仔細審核內容品質
- 注意法規來源的準確性
- 確保生成內容的實用性

## 🔮 未來改進

### 1. 智能推薦
- 根據歷史審核結果推薦法規組合
- 自動識別高品質的生成模式
- 智能調整生成參數

### 2. 批量操作增強
- 支援批量編輯功能
- 批量標記和分類
- 批量匯出功能

### 3. 審批流程優化
- 支援審批意見記錄
- 審批歷史追蹤
- 協作審批功能

## 📝 使用範例

### 範例 1：快速批量生成
1. 選擇「批量生成」模式
2. 設定生成數量為 10
3. 啟用隨機法規選擇
4. 選擇 5-8 個相關法規
5. 點擊生成並逐筆審核

### 範例 2：精確單筆生成
1. 選擇「單筆生成」模式
2. 選擇特定法規組合
3. 生成並仔細審核
4. 如不滿意可重新生成

### 範例 3：混合審批策略
1. 使用批量生成快速產生候選資料
2. 逐筆審核並選擇高品質資料
3. 對不合格資料進行重新生成
4. 最終確認所有選擇的資料

這個新功能大幅提升了資料生成的效率和品質控制能力，讓管理員能夠更有效地從法規生成高品質的訓練資料。 